// Generated by CoffeeScript 1.12.6
(function() {
  var WanderingCountryReference, moment, seem;

  moment = require('moment');

  seem = require('seem');

  WanderingCountryReference = (function() {
    function WanderingCountryReference(ref_db) {
      this.ref_db = ref_db;
    }

    WanderingCountryReference.prototype._for = seem(function*(start_date, end_date, cb) {
      var end_key, start_key, start_month;
      start_key = moment(start_date, 'YYYY-MM-DD').subtract(1, 'days');
      end_key = moment(end_date, 'YYYY-MM-DD').add(1, 'days');
      start_month = start_key.clone().startOf('month');
      while (start_month.isBefore(end_key)) {
        yield seem((function(_this) {
          return function*() {
            var db;
            db = _this.ref_db(start_month.format('YYYY-MM'));
            start_month.add(1, 'months');
            if (db == null) {
              return;
            }
            yield cb(db, start_key, end_key);
            yield db.close();
            return db = null;
          };
        })(this))();
      }
      return null;
    });

    WanderingCountryReference.prototype.references = seem(function*(references, start_date, end_date) {
      var result;
      result = {};
      yield this._for(start_date, end_date, seem((function(_this) {
        return function*(db) {
          var rows;
          rows = (yield db.query('grumpy-actor/tags', {
            keys: references,
            group: false,
            reduce: false,
            include_docs: true
          })).rows;
          return rows.forEach(function(row) {
            var name;
            return (result[name = row.key] != null ? result[name] : result[name] = []).push(row.doc);
          });
        };
      })(this)));
      return result;
    });

    WanderingCountryReference.prototype.query = seem(function*(type, type_value, start_date, end_date, include_docs) {
      var result;
      if (include_docs == null) {
        include_docs = false;
      }
      result = {};
      yield this._for(start_date, end_date, seem((function(_this) {
        return function*(db, start_key, end_key) {
          var rows;
          rows = (yield db.query('grumpy-actor/tags', {
            startkey: [type, type_value, start_key.format('YYYY-MM-DD')],
            endkey: [type, type_value, end_key.format('YYYY-MM-DD')],
            group: !include_docs,
            reduce: !include_docs,
            include_docs: include_docs
          })).rows;
          return rows.forEach(function(arg) {
            var date, doc, r, ref, t, tv;
            (ref = arg.key, t = ref[0], tv = ref[1], date = ref[2], r = ref[3]), doc = arg.doc;
            if (result[date] == null) {
              result[date] = [];
            }
            if (include_docs) {
              return result[date].push(doc);
            } else {
              return result[date].push(r);
            }
          });
        };
      })(this)));
      return result;
    });

    return WanderingCountryReference;

  })();

  module.exports = {
    WanderingCountryReference: WanderingCountryReference
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVmZXJlbmNlLmNvZmZlZS5tZCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUk7QUFBQSxNQUFBOztFQUFBLE1BQUEsR0FBUyxPQUFBLENBQVEsUUFBUjs7RUFDVCxJQUFBLEdBQU8sT0FBQSxDQUFRLE1BQVI7O0VBSUQ7SUFFUyxtQ0FBQyxNQUFEO01BQUMsSUFBQyxDQUFBLFNBQUQ7SUFBRDs7d0NBRWIsSUFBQSxHQUFNLElBQUEsQ0FBSyxVQUFDLFVBQUQsRUFBWSxRQUFaLEVBQXFCLEVBQXJCO0FBRVQsVUFBQTtNQUFBLFNBQUEsR0FBWSxNQUFBLENBQU8sVUFBUCxFQUFtQixZQUFuQixDQUNWLENBQUMsUUFEUyxDQUNBLENBREEsRUFDRyxNQURIO01BR1osT0FBQSxHQUFVLE1BQUEsQ0FBTyxRQUFQLEVBQWlCLFlBQWpCLENBQ1IsQ0FBQyxHQURPLENBQ0gsQ0FERyxFQUNBLE1BREE7TUFHVixXQUFBLEdBQWMsU0FBUyxDQUFDLEtBQVYsQ0FBQSxDQUNaLENBQUMsT0FEVyxDQUNILE9BREc7QUFHZCxhQUFNLFdBQVcsQ0FBQyxRQUFaLENBQXFCLE9BQXJCLENBQU47UUFDRSxNQUFTLElBQUEsQ0FBSyxDQUFBLFNBQUEsS0FBQTtpQkFBQSxVQUFBO0FBQ1osZ0JBQUE7WUFBQSxFQUFBLEdBQUssS0FBQyxDQUFBLE1BQUQsQ0FBUSxXQUFXLENBQUMsTUFBWixDQUFtQixTQUFuQixDQUFSO1lBQ0wsV0FBVyxDQUFDLEdBQVosQ0FBZ0IsQ0FBaEIsRUFBbUIsUUFBbkI7WUFDQSxJQUFjLFVBQWQ7QUFBQSxxQkFBQTs7WUFFQSxNQUFNLEVBQUEsQ0FBRyxFQUFILEVBQU8sU0FBUCxFQUFrQixPQUFsQjtZQUNOLE1BQU0sRUFBRSxDQUFDLEtBQUgsQ0FBQTttQkFDTixFQUFBLEdBQUs7VUFQTztRQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBTCxDQUFILENBQUE7TUFEUjthQVVBO0lBckJTLENBQUw7O3dDQXlCTixVQUFBLEdBQVksSUFBQSxDQUFLLFVBQUMsVUFBRCxFQUFZLFVBQVosRUFBdUIsUUFBdkI7QUFFZixVQUFBO01BQUEsTUFBQSxHQUFTO01BRVQsTUFBTSxJQUFDLENBQUEsSUFBRCxDQUFNLFVBQU4sRUFBa0IsUUFBbEIsRUFBNEIsSUFBQSxDQUFLLENBQUEsU0FBQSxLQUFBO2VBQUEsVUFBQyxFQUFEO0FBRXJDLGNBQUE7VUFBQyxPQUFRLENBQUEsTUFBTSxFQUFFLENBQUMsS0FBSCxDQUFTLG1CQUFULEVBQ2I7WUFBQSxJQUFBLEVBQU0sVUFBTjtZQUNBLEtBQUEsRUFBTyxLQURQO1lBRUEsTUFBQSxFQUFRLEtBRlI7WUFHQSxZQUFBLEVBQWMsSUFIZDtXQURhLENBQU47aUJBTVQsSUFBSSxDQUFDLE9BQUwsQ0FBYSxTQUFDLEdBQUQ7QUFDWCxnQkFBQTttQkFBQSxrQ0FBQyxlQUFBLGVBQW1CLEVBQXBCLENBQXVCLENBQUMsSUFBeEIsQ0FBNkIsR0FBRyxDQUFDLEdBQWpDO1VBRFcsQ0FBYjtRQVJxQztNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBTCxDQUE1QjthQVdOO0lBZmUsQ0FBTDs7d0NBbUJaLEtBQUEsR0FBTyxJQUFBLENBQUssVUFBQyxJQUFELEVBQU0sVUFBTixFQUFpQixVQUFqQixFQUE0QixRQUE1QixFQUFxQyxZQUFyQztBQUVWLFVBQUE7O1FBRitDLGVBQWU7O01BRTlELE1BQUEsR0FBUztNQUVULE1BQU0sSUFBQyxDQUFBLElBQUQsQ0FBTSxVQUFOLEVBQWtCLFFBQWxCLEVBQTRCLElBQUEsQ0FBSyxDQUFBLFNBQUEsS0FBQTtlQUFBLFVBQUMsRUFBRCxFQUFJLFNBQUosRUFBYyxPQUFkO0FBRXJDLGNBQUE7VUFBQyxPQUFRLENBQUEsTUFBTSxFQUFFLENBQUMsS0FBSCxDQUFTLG1CQUFULEVBQ2I7WUFBQSxRQUFBLEVBQVUsQ0FDUixJQURRLEVBRVIsVUFGUSxFQUdSLFNBQVMsQ0FBQyxNQUFWLENBQWlCLFlBQWpCLENBSFEsQ0FBVjtZQUtBLE1BQUEsRUFBUSxDQUNOLElBRE0sRUFFTixVQUZNLEVBR04sT0FBTyxDQUFDLE1BQVIsQ0FBZSxZQUFmLENBSE0sQ0FMUjtZQVVBLEtBQUEsRUFBTyxDQUFJLFlBVlg7WUFXQSxNQUFBLEVBQVEsQ0FBSSxZQVhaO1lBWUEsWUFBQSxFQUFjLFlBWmQ7V0FEYSxDQUFOO2lCQWVULElBQUksQ0FBQyxPQUFMLENBQWEsU0FBQyxHQUFEO0FBQ1gsZ0JBQUE7dUJBRGEsS0FBSyxZQUFFLGFBQUcsZUFBSyxhQUFHOztjQUMvQixNQUFPLENBQUEsSUFBQSxJQUFTOztZQUNoQixJQUFHLFlBQUg7cUJBQ0UsTUFBTyxDQUFBLElBQUEsQ0FBSyxDQUFDLElBQWIsQ0FBa0IsR0FBbEIsRUFERjthQUFBLE1BQUE7cUJBR0UsTUFBTyxDQUFBLElBQUEsQ0FBSyxDQUFDLElBQWIsQ0FBa0IsQ0FBbEIsRUFIRjs7VUFGVyxDQUFiO1FBakJxQztNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBTCxDQUE1QjthQXdCTjtJQTVCVSxDQUFMOzs7Ozs7RUE4QlQsTUFBTSxDQUFDLE9BQVAsR0FBaUI7SUFBQywyQkFBQSx5QkFBRDs7QUFuRmpCIiwic291cmNlc0NvbnRlbnQiOlsiICAgIG1vbWVudCA9IHJlcXVpcmUgJ21vbWVudCdcbiAgICBzZWVtID0gcmVxdWlyZSAnc2VlbSdcblxuIyMjIEV4dGVuZGVkIENEUnMgKGNsaWVudC1zaWRlKVxuXG4gICAgY2xhc3MgV2FuZGVyaW5nQ291bnRyeVJlZmVyZW5jZVxuXG4gICAgICBjb25zdHJ1Y3RvcjogKEByZWZfZGIpIC0+XG5cbiAgICAgIF9mb3I6IHNlZW0gKHN0YXJ0X2RhdGUsZW5kX2RhdGUsY2IpIC0+XG5cbiAgICAgICAgc3RhcnRfa2V5ID0gbW9tZW50IHN0YXJ0X2RhdGUsICdZWVlZLU1NLUREJ1xuICAgICAgICAgIC5zdWJ0cmFjdCAxLCAnZGF5cydcblxuICAgICAgICBlbmRfa2V5ID0gbW9tZW50IGVuZF9kYXRlLCAnWVlZWS1NTS1ERCdcbiAgICAgICAgICAuYWRkIDEsICdkYXlzJ1xuXG4gICAgICAgIHN0YXJ0X21vbnRoID0gc3RhcnRfa2V5LmNsb25lKClcbiAgICAgICAgICAuc3RhcnRPZiAnbW9udGgnXG5cbiAgICAgICAgd2hpbGUgc3RhcnRfbW9udGguaXNCZWZvcmUgZW5kX2tleVxuICAgICAgICAgIHlpZWxkIGRvIHNlZW0gPT5cbiAgICAgICAgICAgIGRiID0gQHJlZl9kYiBzdGFydF9tb250aC5mb3JtYXQgJ1lZWVktTU0nXG4gICAgICAgICAgICBzdGFydF9tb250aC5hZGQgMSwgJ21vbnRocydcbiAgICAgICAgICAgIHJldHVybiB1bmxlc3MgZGI/XG5cbiAgICAgICAgICAgIHlpZWxkIGNiIGRiLCBzdGFydF9rZXksIGVuZF9rZXlcbiAgICAgICAgICAgIHlpZWxkIGRiLmNsb3NlKClcbiAgICAgICAgICAgIGRiID0gbnVsbFxuXG4gICAgICAgIG51bGxcblxuR2F0aGVyIGFsbCBkb2N1bWVudHMgbGlua2VkIHRvIGEgc2V0IG9mIHJlZmVyZW5jZXMuXG5cbiAgICAgIHJlZmVyZW5jZXM6IHNlZW0gKHJlZmVyZW5jZXMsc3RhcnRfZGF0ZSxlbmRfZGF0ZSkgLT5cblxuICAgICAgICByZXN1bHQgPSB7fVxuXG4gICAgICAgIHlpZWxkIEBfZm9yIHN0YXJ0X2RhdGUsIGVuZF9kYXRlLCBzZWVtIChkYikgPT5cblxuICAgICAgICAgIHtyb3dzfSA9IHlpZWxkIGRiLnF1ZXJ5ICdncnVtcHktYWN0b3IvdGFncycsXG4gICAgICAgICAgICBrZXlzOiByZWZlcmVuY2VzXG4gICAgICAgICAgICBncm91cDogbm9cbiAgICAgICAgICAgIHJlZHVjZTogbm9cbiAgICAgICAgICAgIGluY2x1ZGVfZG9jczogeWVzXG5cbiAgICAgICAgICByb3dzLmZvckVhY2ggKHJvdykgLT5cbiAgICAgICAgICAgIChyZXN1bHRbcm93LmtleV0gPz0gW10pLnB1c2ggcm93LmRvY1xuXG4gICAgICAgIHJlc3VsdFxuXG5RdWVyeSBkb2N1bWVudHMgYmFzZWQgb24gdHlwZS92YWx1ZSwgYW5kIHJldHVybiBhIHNldCBvZiByZWZlcmVuY2VzIG9yIHRoZSBkb2N1bWVudHMsIGdyb3VwZWQgYnkgZGF0ZS5cblxuICAgICAgcXVlcnk6IHNlZW0gKHR5cGUsdHlwZV92YWx1ZSxzdGFydF9kYXRlLGVuZF9kYXRlLGluY2x1ZGVfZG9jcyA9IGZhbHNlKSAtPlxuXG4gICAgICAgIHJlc3VsdCA9IHt9XG5cbiAgICAgICAgeWllbGQgQF9mb3Igc3RhcnRfZGF0ZSwgZW5kX2RhdGUsIHNlZW0gKGRiLHN0YXJ0X2tleSxlbmRfa2V5KSA9PlxuXG4gICAgICAgICAge3Jvd3N9ID0geWllbGQgZGIucXVlcnkgJ2dydW1weS1hY3Rvci90YWdzJyxcbiAgICAgICAgICAgIHN0YXJ0a2V5OiBbXG4gICAgICAgICAgICAgIHR5cGVcbiAgICAgICAgICAgICAgdHlwZV92YWx1ZVxuICAgICAgICAgICAgICBzdGFydF9rZXkuZm9ybWF0ICdZWVlZLU1NLUREJ1xuICAgICAgICAgICAgXVxuICAgICAgICAgICAgZW5ka2V5OiBbXG4gICAgICAgICAgICAgIHR5cGVcbiAgICAgICAgICAgICAgdHlwZV92YWx1ZVxuICAgICAgICAgICAgICBlbmRfa2V5LmZvcm1hdCAnWVlZWS1NTS1ERCdcbiAgICAgICAgICAgIF1cbiAgICAgICAgICAgIGdyb3VwOiBub3QgaW5jbHVkZV9kb2NzXG4gICAgICAgICAgICByZWR1Y2U6IG5vdCBpbmNsdWRlX2RvY3NcbiAgICAgICAgICAgIGluY2x1ZGVfZG9jczogaW5jbHVkZV9kb2NzXG5cbiAgICAgICAgICByb3dzLmZvckVhY2ggKHtrZXk6W3QsdHYsZGF0ZSxyXSxkb2N9KSAtPlxuICAgICAgICAgICAgcmVzdWx0W2RhdGVdID89IFtdXG4gICAgICAgICAgICBpZiBpbmNsdWRlX2RvY3NcbiAgICAgICAgICAgICAgcmVzdWx0W2RhdGVdLnB1c2ggZG9jXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgIHJlc3VsdFtkYXRlXS5wdXNoIHJcblxuICAgICAgICByZXN1bHRcblxuICAgIG1vZHVsZS5leHBvcnRzID0ge1dhbmRlcmluZ0NvdW50cnlSZWZlcmVuY2V9XG4iXX0=
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/wandering-country/reference.coffee.md