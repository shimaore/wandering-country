// Generated by CoffeeScript 1.12.4
(function() {
  var debug, seem, sleep, update_version;

  seem = require('seem');

  debug = (require('debug'))('update-version');

  sleep = require('./sleep');

  module.exports = update_version = seem(function*(db, ddoc) {
    var _rev, ref, results, timer, version;
    version = null;
    timer = 43 + Math.random() * 319;
    results = [];
    while (version !== ddoc.version) {
      ref = (yield db.get(ddoc._id)["catch"](function(error) {
        if (error.status === 409) {
          return {};
        } else {
          return Promise.reject(error);
        }
      })), version = ref.version, _rev = ref._rev;
      if (version !== ddoc.version) {
        debug('updating design document', ddoc._id, ddoc.version);
        if (_rev != null) {
          ddoc._rev = _rev;
        }
        yield sleep(timer);
        timer *= 2 + Math.random();
        results.push((yield db.put(ddoc)["catch"](function() {
          return null;
        })));
      } else {
        results.push(void 0);
      }
    }
    return results;
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXZlcnNpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1cGRhdGUtdmVyc2lvbi5jb2ZmZWUubWQiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFJO0FBQUEsTUFBQTs7RUFBQSxJQUFBLEdBQU8sT0FBQSxDQUFRLE1BQVI7O0VBQ1AsS0FBQSxHQUFRLENBQUMsT0FBQSxDQUFRLE9BQVIsQ0FBRCxDQUFBLENBQWtCLGdCQUFsQjs7RUFDUixLQUFBLEdBQVEsT0FBQSxDQUFRLFNBQVI7O0VBRVIsTUFBTSxDQUFDLE9BQVAsR0FBaUIsY0FBQSxHQUFpQixJQUFBLENBQUssVUFBQyxFQUFELEVBQUksSUFBSjtBQUNyQyxRQUFBO0lBQUEsT0FBQSxHQUFVO0lBQ1YsS0FBQSxHQUFRLEVBQUEsR0FBRyxJQUFJLENBQUMsTUFBTCxDQUFBLENBQUEsR0FBYztBQUN6QjtXQUFNLE9BQUEsS0FBVyxJQUFJLENBQUMsT0FBdEI7TUFFRSxNQUFpQixDQUFBLE1BQU0sRUFDckIsQ0FBQyxHQURvQixDQUNoQixJQUFJLENBQUMsR0FEVyxDQUVyQixFQUFDLEtBQUQsRUFGcUIsQ0FFZCxTQUFDLEtBQUQ7UUFDTCxJQUFHLEtBQUssQ0FBQyxNQUFOLEtBQWdCLEdBQW5CO2lCQUNFLEdBREY7U0FBQSxNQUFBO2lCQUdFLE9BQU8sQ0FBQyxNQUFSLENBQWUsS0FBZixFQUhGOztNQURLLENBRmMsQ0FBTixDQUFqQixFQUFDLHFCQUFELEVBQVM7TUFRVCxJQUFPLE9BQUEsS0FBVyxJQUFJLENBQUMsT0FBdkI7UUFDRSxLQUFBLENBQU0sMEJBQU4sRUFBa0MsSUFBSSxDQUFDLEdBQXZDLEVBQTRDLElBQUksQ0FBQyxPQUFqRDtRQUNBLElBQUcsWUFBSDtVQUNFLElBQUksQ0FBQyxJQUFMLEdBQVksS0FEZDs7UUFLQSxNQUFNLEtBQUEsQ0FBTSxLQUFOO1FBRU4sS0FBQSxJQUFTLENBQUEsR0FBSSxJQUFJLENBQUMsTUFBTCxDQUFBO3FCQUViLENBQUEsTUFBTSxFQUNKLENBQUMsR0FERyxDQUNDLElBREQsQ0FFSixFQUFDLEtBQUQsRUFGSSxDQUVHLFNBQUE7aUJBQUc7UUFBSCxDQUZILENBQU4sR0FYRjtPQUFBLE1BQUE7NkJBQUE7O0lBVkYsQ0FBQTs7RUFIcUMsQ0FBTDtBQUpsQyIsInNvdXJjZXNDb250ZW50IjpbIiAgICBzZWVtID0gcmVxdWlyZSAnc2VlbSdcbiAgICBkZWJ1ZyA9IChyZXF1aXJlICdkZWJ1ZycpICd1cGRhdGUtdmVyc2lvbidcbiAgICBzbGVlcCA9IHJlcXVpcmUgJy4vc2xlZXAnXG5cbiAgICBtb2R1bGUuZXhwb3J0cyA9IHVwZGF0ZV92ZXJzaW9uID0gc2VlbSAoZGIsZGRvYykgLT5cbiAgICAgIHZlcnNpb24gPSBudWxsXG4gICAgICB0aW1lciA9IDQzK01hdGgucmFuZG9tKCkqMzE5XG4gICAgICB1bnRpbCB2ZXJzaW9uIGlzIGRkb2MudmVyc2lvblxuXG4gICAgICAgIHt2ZXJzaW9uLF9yZXZ9ID0geWllbGQgZGJcbiAgICAgICAgICAuZ2V0IGRkb2MuX2lkXG4gICAgICAgICAgLmNhdGNoIChlcnJvcikgLT5cbiAgICAgICAgICAgIGlmIGVycm9yLnN0YXR1cyBpcyA0MDlcbiAgICAgICAgICAgICAge31cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgUHJvbWlzZS5yZWplY3QgZXJyb3JcblxuICAgICAgICB1bmxlc3MgdmVyc2lvbiBpcyBkZG9jLnZlcnNpb25cbiAgICAgICAgICBkZWJ1ZyAndXBkYXRpbmcgZGVzaWduIGRvY3VtZW50JywgZGRvYy5faWQsIGRkb2MudmVyc2lvblxuICAgICAgICAgIGlmIF9yZXY/XG4gICAgICAgICAgICBkZG9jLl9yZXYgPSBfcmV2XG5cbkludHJvZHVjZSBhIGRlbGF5IGluIGNhc2UgdGhlIHVzZXIgaXMgdHJ5aW5nIHRoaXMgb3BlcmF0aW9uIG11bHRpcGxlIHRpbWVzIGNvbmN1cnJlbnRseS5cblxuICAgICAgICAgIHlpZWxkIHNsZWVwIHRpbWVyXG5cbiAgICAgICAgICB0aW1lciAqPSAyICsgTWF0aC5yYW5kb20oKVxuXG4gICAgICAgICAgeWllbGQgZGJcbiAgICAgICAgICAgIC5wdXQgZGRvY1xuICAgICAgICAgICAgLmNhdGNoIC0+IG51bGxcbiJdfQ==
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/wandering-country/update-version.coffee.md